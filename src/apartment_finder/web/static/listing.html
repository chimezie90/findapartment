<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Details - Apartment Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.5rem;
        }

        header a {
            color: #3498db;
            text-decoration: none;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: white;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
        }

        .listing-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .listing-price {
            font-size: 2rem;
            font-weight: 700;
            color: #27ae60;
        }

        .listing-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tag-city { background: #e8f4f8; color: #2980b9; }
        .tag-source { background: #f3e5f5; color: #8e24aa; }

        .view-listing-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            margin-top: 15px;
        }

        .view-listing-btn:hover {
            background: #2980b9;
        }

        /* Map */
        #detailMap {
            height: 400px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #666;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Scores */
        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .score-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .score-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .score-good { color: #27ae60; }
        .score-ok { color: #f39c12; }
        .score-bad { color: #e74c3c; }

        /* Nearby places */
        .places-list {
            list-style: none;
        }

        .places-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .places-list li:last-child {
            border-bottom: none;
        }

        .place-name {
            font-weight: 500;
        }

        .place-distance {
            color: #666;
            font-size: 0.9rem;
        }

        .place-icon {
            margin-right: 8px;
        }

        .place-link {
            color: #2c3e50;
            text-decoration: none;
            transition: color 0.2s;
        }

        .place-link:hover {
            color: #3498db;
            text-decoration: underline;
        }

        .no-places {
            color: #999;
            font-style: italic;
            padding: 10px 0;
        }

        /* Ratings */
        .ratings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .rating-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .rating-card h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: #2c3e50;
        }

        .rating-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .rating-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-btn:hover {
            border-color: #3498db;
            transform: scale(1.1);
        }

        .rating-btn.active {
            border-color: #3498db;
            background: #e8f4f8;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Comments */
        .comments-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .comment {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #666;
        }

        .comment-author {
            font-weight: 600;
            color: #2c3e50;
        }

        .comment-text {
            color: #333;
        }

        .comment-form {
            margin-top: 15px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .comment-form button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }

        .comment-form button:hover {
            background: #219a52;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* City Suitability */
        .suitability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .suitability-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .suitability-item.high {
            border-left-color: #27ae60;
            background: #f0fdf4;
        }

        .suitability-item.medium {
            border-left-color: #f39c12;
            background: #fffbeb;
        }

        .suitability-item.low {
            border-left-color: #e74c3c;
            background: #fef2f2;
        }

        .suitability-label {
            font-weight: 500;
            color: #2c3e50;
        }

        .suitability-rating {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suitability-dots {
            display: flex;
            gap: 3px;
        }

        .suitability-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
        }

        .suitability-dot.filled.high { background: #27ae60; }
        .suitability-dot.filled.medium { background: #f39c12; }
        .suitability-dot.filled.low { background: #e74c3c; }

        .suitability-text {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .suitability-text.high { color: #27ae60; }
        .suitability-text.medium { color: #f39c12; }
        .suitability-text.low { color: #e74c3c; }

        .city-summary {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }

        .city-summary h3 {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }

        .city-summary p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Image Gallery */
        .gallery-card {
            padding: 0;
            overflow: hidden;
        }

        .gallery-container {
            position: relative;
            background: #1a1a1a;
        }

        .gallery-main {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .gallery-main img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .gallery-placeholder {
            color: #666;
            text-align: center;
            padding: 60px 20px;
        }

        .gallery-placeholder span {
            font-size: 4rem;
            display: block;
            margin-bottom: 15px;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 10;
        }

        .gallery-nav:hover {
            background: white;
        }

        .gallery-nav.prev {
            left: 15px;
        }

        .gallery-nav.next {
            right: 15px;
        }

        .gallery-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .gallery-thumbnails {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
            background: #f8f9fa;
        }

        .gallery-thumb {
            width: 80px;
            height: 60px;
            flex-shrink: 0;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .gallery-thumb.active {
            border-color: #3498db;
        }

        .gallery-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-counter {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .listing-header {
                flex-direction: column;
            }

            .scores-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .gallery-main {
                height: 280px;
            }

            .gallery-thumb {
                width: 60px;
                height: 45px;
            }

            .ratings-row, .comments-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="back-link">‚Üê Back to listings</a>
            <h1 id="headerTitle">Loading...</h1>
        </div>
    </header>

    <div class="container">
        <div class="card gallery-card" id="galleryCard" style="display: none;">
            <div class="gallery-container">
                <div class="gallery-main" id="galleryMain">
                    <div class="gallery-placeholder">
                        <span>üì∑</span>
                        <p>Loading images...</p>
                    </div>
                </div>
                <button class="gallery-nav prev" onclick="prevImage()" id="prevBtn">‚Äπ</button>
                <button class="gallery-nav next" onclick="nextImage()" id="nextBtn">‚Ä∫</button>
                <div class="gallery-counter" id="galleryCounter"></div>
            </div>
            <div class="gallery-thumbnails" id="galleryThumbnails"></div>
        </div>

        <div class="card" id="listingCard">
            <div class="loading">Loading listing details...</div>
        </div>

        <div class="card">
            <h2>Location & Walkability</h2>
            <div id="detailMap"></div>
            <div class="map-legend" id="mapLegend">
                <div class="legend-item"><div class="legend-dot" style="background:#e74c3c"></div> Restaurants</div>
                <div class="legend-item"><div class="legend-dot" style="background:#3498db"></div> Gyms</div>
                <div class="legend-item"><div class="legend-dot" style="background:#9b59b6"></div> Ice Rinks</div>
                <div class="legend-item"><div class="legend-dot" style="background:#1abc9c"></div> Pilates</div>
                <div class="legend-item"><div class="legend-dot" style="background:#e67e22"></div> Basketball</div>
                <div class="legend-item"><div class="legend-dot" style="background:#27ae60"></div> Grocery</div>
            </div>
            <div class="scores-grid" id="scoresGrid">
                <div class="score-item">
                    <div class="score-value" id="walkScore">--</div>
                    <div class="score-label">Walk Score</div>
                </div>
                <div class="score-item">
                    <div class="score-value" id="transitScore">--</div>
                    <div class="score-label">Transit Score</div>
                </div>
                <div class="score-item">
                    <div class="score-value" id="bikeScore">--</div>
                    <div class="score-label">Bike Score</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Nearby Restaurants</h2>
            <ul class="places-list" id="restaurantsList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Gyms</h2>
            <ul class="places-list" id="gymsList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Ice Skating Rinks</h2>
            <ul class="places-list" id="skatingList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Pilates Studios</h2>
            <ul class="places-list" id="pilatesList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Basketball Courts</h2>
            <ul class="places-list" id="basketballList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Grocery Stores</h2>
            <ul class="places-list" id="groceryList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card" id="suitabilityCard">
            <h2>City Suitability for E & A</h2>
            <div class="suitability-grid" id="suitabilityGrid">
                <div class="loading">Loading...</div>
            </div>
            <div class="city-summary" id="citySummary"></div>
        </div>

        <div class="card">
            <h2>Our Ratings</h2>
            <div class="ratings-row">
                <div class="rating-card">
                    <h3>Adoyo</h3>
                    <div class="rating-buttons">
                        <button class="rating-btn" data-author="Adoyo" data-rating="happy" onclick="submitRating('Adoyo','happy')">üòä</button>
                        <button class="rating-btn" data-author="Adoyo" data-rating="neutral" onclick="submitRating('Adoyo','neutral')">üòê</button>
                        <button class="rating-btn" data-author="Adoyo" data-rating="sad" onclick="submitRating('Adoyo','sad')">üò¢</button>
                    </div>
                </div>
                <div class="rating-card">
                    <h3>Emmanuel</h3>
                    <div class="rating-buttons">
                        <button class="rating-btn" data-author="Emmanuel" data-rating="happy" onclick="submitRating('Emmanuel','happy')">üòä</button>
                        <button class="rating-btn" data-author="Emmanuel" data-rating="neutral" onclick="submitRating('Emmanuel','neutral')">üòê</button>
                        <button class="rating-btn" data-author="Emmanuel" data-rating="sad" onclick="submitRating('Emmanuel','sad')">üò¢</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="comments-row">
            <div class="card">
                <h2>Adoyo's Notes</h2>
                <div id="commentsAdoyo"></div>
                <div class="comment-form">
                    <textarea id="commentTextAdoyo" placeholder="Add a note..."></textarea>
                    <button onclick="submitComment('Adoyo')">Post</button>
                </div>
            </div>
            <div class="card">
                <h2>Emmanuel's Notes</h2>
                <div id="commentsEmmanuel"></div>
                <div class="comment-form">
                    <textarea id="commentTextEmmanuel" placeholder="Add a note..."></textarea>
                    <button onclick="submitComment('Emmanuel')">Post</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let listing = null;
        let map = null;
        let galleryImages = [];
        let currentImageIndex = 0;
        let placeMarkers = []; // Store all place markers
        const listingId = new URLSearchParams(window.location.search).get('id');

        // Marker colors for different place types
        const markerColors = {
            restaurant: '#e74c3c',
            gym: '#3498db',
            skating: '#9b59b6',
            pilates: '#1abc9c',
            basketball: '#e67e22',
            grocery: '#27ae60'
        };

        // City centers for fallback
        const cityCenters = {
            'New York City': { lat: 40.7128, lng: -74.0060 },
            'New York': { lat: 40.7128, lng: -74.0060 },
            'Los Angeles': { lat: 34.0522, lng: -118.2437 },
            'Dubai': { lat: 25.2048, lng: 55.2708 },
            'Lisbon': { lat: 38.7223, lng: -9.1393 },
            'Copenhagen': { lat: 55.6761, lng: 12.5683 },
            'Bali': { lat: -8.4095, lng: 115.1889 }
        };

        async function loadListing() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}`);
                if (!response.ok) throw new Error('Listing not found');
                listing = await response.json();
                renderListing();
                initMap();
                loadNearbyPlaces();
                loadComments();
                loadRatings();
                loadGalleryImages();
                renderCitySuitability();
            } catch (error) {
                document.getElementById('listingCard').innerHTML = `
                    <div class="loading">Error: ${error.message}</div>
                `;
            }
        }

        async function loadGalleryImages() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/images`);
                const data = await response.json();
                galleryImages = data.images || [];

                if (galleryImages.length > 0) {
                    document.getElementById('galleryCard').style.display = 'block';
                    renderGallery();
                }
            } catch (error) {
                console.error('Error loading gallery images:', error);
            }
        }

        function renderGallery() {
            if (galleryImages.length === 0) return;

            // Main image
            const mainEl = document.getElementById('galleryMain');
            mainEl.innerHTML = `<img src="${galleryImages[currentImageIndex]}" alt="Listing photo ${currentImageIndex + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üè†</text></svg>'">`;

            // Counter
            document.getElementById('galleryCounter').textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;

            // Navigation buttons
            document.getElementById('prevBtn').disabled = currentImageIndex === 0;
            document.getElementById('nextBtn').disabled = currentImageIndex === galleryImages.length - 1;

            // Thumbnails
            const thumbsEl = document.getElementById('galleryThumbnails');
            thumbsEl.innerHTML = galleryImages.map((img, idx) => `
                <div class="gallery-thumb ${idx === currentImageIndex ? 'active' : ''}" onclick="goToImage(${idx})">
                    <img src="${img}" alt="Thumbnail ${idx + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üè†</text></svg>'">
                </div>
            `).join('');

            // Scroll active thumbnail into view
            const activeThumb = thumbsEl.querySelector('.active');
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function prevImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                renderGallery();
            }
        }

        function nextImage() {
            if (currentImageIndex < galleryImages.length - 1) {
                currentImageIndex++;
                renderGallery();
            }
        }

        function goToImage(idx) {
            currentImageIndex = idx;
            renderGallery();
        }

        // City suitability data for E & A's criteria
        const citySuitability = {
            'New York City': {
                immigration: { rating: 'high', note: 'E already has work visa, A can get entrepreneur visa' },
                work: { rating: 'high', note: 'DoorDash HQ nearby, strong startup scene for A' },
                weather: { rating: 'medium', note: 'Cold winters, hot summers, 4 seasons' },
                family_access: { rating: 'high', note: 'Direct flights to Seattle, Atlanta, Copenhagen' },
                calmness: { rating: 'low', note: 'Very busy city, limited nature access' },
                culture: { rating: 'high', note: 'World-class dining, arts, entertainment' },
                healthy_food: { rating: 'high', note: 'Many healthy options, farmers markets' },
                fitness: { rating: 'high', note: 'Many skating rinks, Pilates, gyms' },
                cost: { rating: 'low', note: 'Very expensive rent and living costs' },
                quality_of_life: { rating: 'high', note: 'Excellent walkability and transit' },
                summary: 'Great for career and culture, but expensive and hectic. Best for short-term career building.'
            },
            'Los Angeles': {
                immigration: { rating: 'high', note: 'Same as NYC for visa options' },
                work: { rating: 'high', note: 'DoorDash office, tech hub, good for A\'s remote work' },
                weather: { rating: 'high', note: 'Sunny year-round, mild temperatures' },
                family_access: { rating: 'medium', note: 'Close to Seattle, far from Copenhagen' },
                calmness: { rating: 'medium', note: 'Beach access, but traffic can be stressful' },
                culture: { rating: 'high', note: 'Entertainment capital, diverse food scene' },
                healthy_food: { rating: 'high', note: 'Health-conscious culture, organic options' },
                fitness: { rating: 'medium', note: 'Gyms and Pilates good, limited skating' },
                cost: { rating: 'low', note: 'High rent, car required adds cost' },
                quality_of_life: { rating: 'medium', note: 'Car-dependent, but great outdoors' },
                summary: 'Best weather in the US with career options. Car-dependent but great for outdoor lifestyle.'
            },
            'Dubai': {
                immigration: { rating: 'high', note: 'Easy work visas, entrepreneur-friendly' },
                work: { rating: 'medium', note: 'Growing tech scene, great for A\'s business' },
                weather: { rating: 'medium', note: 'Very hot summers, mild winters, sunny' },
                family_access: { rating: 'low', note: 'Far from Seattle and Copenhagen' },
                calmness: { rating: 'high', note: 'Peaceful, modern, ocean access' },
                culture: { rating: 'medium', note: 'Developing arts scene, diverse expat community' },
                healthy_food: { rating: 'high', note: 'Great healthy dining, quality groceries' },
                fitness: { rating: 'high', note: 'Excellent gyms, ice rinks, sports facilities' },
                cost: { rating: 'medium', note: 'No income tax, moderate rent' },
                quality_of_life: { rating: 'high', note: 'Safe, modern, convenient' },
                summary: 'Tax-free with great fitness facilities. Far from family but peaceful and modern lifestyle.'
            },
            'Lisbon': {
                immigration: { rating: 'medium', note: 'D7 visa available, EU access for A' },
                work: { rating: 'medium', note: 'Growing tech hub, good for remote work' },
                weather: { rating: 'high', note: 'Mild year-round, sunny, near ocean' },
                family_access: { rating: 'medium', note: 'Good flights to Copenhagen, far from US' },
                calmness: { rating: 'high', note: 'Relaxed lifestyle, beaches nearby' },
                culture: { rating: 'high', note: 'Rich history, great food and wine' },
                healthy_food: { rating: 'high', note: 'Fresh seafood, markets, Mediterranean diet' },
                fitness: { rating: 'medium', note: 'Gyms available, limited skating options' },
                cost: { rating: 'high', note: 'Much lower cost than US cities' },
                quality_of_life: { rating: 'high', note: 'Walkable, safe, friendly' },
                summary: 'Best value with great weather and lifestyle. Perfect for a calmer pace while staying connected to Europe.'
            },
            'Copenhagen': {
                immigration: { rating: 'high', note: 'A is Danish, E can get family/work visa' },
                work: { rating: 'medium', note: 'Good startup scene, but limited for E\'s company' },
                weather: { rating: 'low', note: 'Long cold winters, limited sun' },
                family_access: { rating: 'medium', note: 'Close to A\'s family, far from E\'s' },
                calmness: { rating: 'high', note: 'Very peaceful, bike-friendly, nature access' },
                culture: { rating: 'high', note: 'World-class dining, design, hygge culture' },
                healthy_food: { rating: 'high', note: 'Excellent organic options, Nordic cuisine' },
                fitness: { rating: 'high', note: 'Bike culture, gyms, skating accessible' },
                cost: { rating: 'low', note: 'High taxes and living costs' },
                quality_of_life: { rating: 'high', note: 'Excellent work-life balance, safe' },
                summary: 'Home base for A with great quality of life. Cold weather is the main downside.'
            },
            'Bali': {
                immigration: { rating: 'high', note: 'Easy tourist/digital nomad visas, affordable extensions' },
                work: { rating: 'medium', note: 'Great for remote work, strong digital nomad community' },
                weather: { rating: 'high', note: 'Tropical year-round, warm with rainy season' },
                family_access: { rating: 'low', note: 'Very far from Seattle, Atlanta, and Copenhagen' },
                calmness: { rating: 'high', note: 'Peaceful beaches, rice terraces, spiritual culture' },
                culture: { rating: 'high', note: 'Rich Balinese culture, temples, ceremonies' },
                healthy_food: { rating: 'high', note: 'Amazing healthy cafes, fresh tropical fruits' },
                fitness: { rating: 'medium', note: 'Yoga everywhere, surfing, some gyms, no skating' },
                cost: { rating: 'high', note: 'Very affordable, great value for money' },
                quality_of_life: { rating: 'high', note: 'Relaxed lifestyle, beautiful nature, friendly locals' },
                summary: 'Best value with tropical paradise lifestyle. Perfect for remote work and wellness, but far from family.'
            }
        };

        function renderCitySuitability() {
            const city = listing?.city;
            let cityData = null;

            // Find matching city data
            for (const [cityName, data] of Object.entries(citySuitability)) {
                if (city?.includes(cityName) || cityName.includes(city)) {
                    cityData = data;
                    break;
                }
            }

            const grid = document.getElementById('suitabilityGrid');
            const summary = document.getElementById('citySummary');

            if (!cityData) {
                grid.innerHTML = '<p class="no-places">City suitability data not available for this location</p>';
                summary.style.display = 'none';
                return;
            }

            const criteria = [
                { key: 'immigration', label: 'Immigration/Visa', icon: 'üõÇ' },
                { key: 'work', label: 'Work Opportunities', icon: 'üíº' },
                { key: 'weather', label: 'Weather/Climate', icon: '‚òÄÔ∏è' },
                { key: 'family_access', label: 'Family Access', icon: '‚úàÔ∏è' },
                { key: 'calmness', label: 'Calmness/Nature', icon: 'üåø' },
                { key: 'culture', label: 'Culture/Experiences', icon: 'üé≠' },
                { key: 'healthy_food', label: 'Healthy Food', icon: 'ü•ó' },
                { key: 'fitness', label: 'Fitness Options', icon: 'üèÉ' },
                { key: 'cost', label: 'Cost of Living', icon: 'üí∞' },
                { key: 'quality_of_life', label: 'Quality of Life', icon: '‚ú®' }
            ];

            grid.innerHTML = criteria.map(({ key, label, icon }) => {
                const item = cityData[key];
                const dots = renderDots(item.rating);
                return `
                    <div class="suitability-item ${item.rating}" title="${escapeHtml(item.note)}">
                        <span class="suitability-label">${icon} ${label}</span>
                        <div class="suitability-rating">
                            <div class="suitability-dots">${dots}</div>
                            <span class="suitability-text ${item.rating}">${item.rating.toUpperCase()}</span>
                        </div>
                    </div>
                `;
            }).join('');

            summary.innerHTML = `
                <h3>Summary for ${escapeHtml(city)}</h3>
                <p>${escapeHtml(cityData.summary)}</p>
            `;
        }

        function renderDots(rating) {
            const count = rating === 'high' ? 3 : rating === 'medium' ? 2 : 1;
            let dots = '';
            for (let i = 0; i < 3; i++) {
                dots += `<span class="suitability-dot ${i < count ? 'filled ' + rating : ''}"></span>`;
            }
            return dots;
        }

        function renderListing() {
            document.getElementById('headerTitle').textContent = listing.title || 'Untitled Listing';
            document.title = `${listing.title || 'Listing'} - Apartment Finder`;

            const price = listing.price_usd
                ? '$' + listing.price_usd.toLocaleString('en-US', { maximumFractionDigits: 0 }) + '/mo'
                : 'Price N/A';

            document.getElementById('listingCard').innerHTML = `
                <div class="listing-header">
                    <div>
                        <h1 class="listing-title">${escapeHtml(listing.title || 'Untitled')}</h1>
                        <div class="listing-meta">
                            <span class="tag tag-city">${escapeHtml(listing.city || 'Unknown')}</span>
                            <span class="tag tag-source">${escapeHtml(listing.source_name || 'Unknown')}</span>
                        </div>
                    </div>
                    <div class="listing-price">${price}</div>
                </div>
                <a href="${listing.url}" target="_blank" rel="noopener" class="view-listing-btn">
                    View Original Listing ‚Üí
                </a>
            `;
        }

        function getCoords() {
            if (listing.latitude && listing.longitude) {
                return { lat: listing.latitude, lng: listing.longitude };
            }
            // Fallback to city center
            for (const [city, coords] of Object.entries(cityCenters)) {
                if (listing.city && listing.city.includes(city)) {
                    return coords;
                }
            }
            return cityCenters['New York City'];
        }

        function initMap() {
            const coords = getCoords();
            map = L.map('detailMap').setView([coords.lat, coords.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Custom marker for the apartment listing
            const homeIcon = L.divIcon({
                className: 'home-marker',
                html: `<div style="background:#2c3e50;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 3px 6px rgba(0,0,0,0.4);font-size:18px;">üè†</div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            L.marker([coords.lat, coords.lng], { icon: homeIcon })
                .bindPopup(`<strong>This Listing</strong><br>${escapeHtml(listing.title || 'Apartment')}`)
                .addTo(map);

            // Estimate walkability based on location
            estimateScores(coords);
        }

        function estimateScores(coords) {
            // Simulate walkability scores based on city
            // In a real app, you'd call Walk Score API
            let walkScore, transitScore, bikeScore;

            if (listing.city?.includes('New York')) {
                walkScore = 85 + Math.floor(Math.random() * 15);
                transitScore = 90 + Math.floor(Math.random() * 10);
                bikeScore = 70 + Math.floor(Math.random() * 20);
            } else if (listing.city?.includes('Los Angeles')) {
                walkScore = 50 + Math.floor(Math.random() * 30);
                transitScore = 40 + Math.floor(Math.random() * 30);
                bikeScore = 55 + Math.floor(Math.random() * 25);
            } else if (listing.city?.includes('Dubai')) {
                walkScore = 40 + Math.floor(Math.random() * 30);
                transitScore = 50 + Math.floor(Math.random() * 30);
                bikeScore = 30 + Math.floor(Math.random() * 20);
            } else if (listing.city?.includes('Copenhagen')) {
                walkScore = 80 + Math.floor(Math.random() * 15);
                transitScore = 85 + Math.floor(Math.random() * 10);
                bikeScore = 95 + Math.floor(Math.random() * 5);  // Copenhagen is famous for biking
            } else if (listing.city?.includes('Lisbon')) {
                walkScore = 75 + Math.floor(Math.random() * 15);
                transitScore = 70 + Math.floor(Math.random() * 20);
                bikeScore = 50 + Math.floor(Math.random() * 20);
            } else if (listing.city?.includes('Bali')) {
                walkScore = 30 + Math.floor(Math.random() * 20);  // Scooter-dependent
                transitScore = 20 + Math.floor(Math.random() * 20);
                bikeScore = 40 + Math.floor(Math.random() * 20);
            } else {
                walkScore = 60 + Math.floor(Math.random() * 30);
                transitScore = 55 + Math.floor(Math.random() * 30);
                bikeScore = 50 + Math.floor(Math.random() * 30);
            }

            setScore('walkScore', walkScore);
            setScore('transitScore', transitScore);
            setScore('bikeScore', bikeScore);
        }

        function setScore(id, score) {
            const el = document.getElementById(id);
            el.textContent = score;
            el.className = 'score-value ' + (score >= 70 ? 'score-good' : score >= 50 ? 'score-ok' : 'score-bad');
        }

        async function loadNearbyPlaces() {
            const coords = getCoords();

            // Clear existing place markers
            placeMarkers.forEach(m => map.removeLayer(m));
            placeMarkers = [];

            // Load restaurants, gyms, skating rinks, pilates, basketball, and grocery
            await Promise.all([
                loadPlaces('restaurantsList', coords, 'amenity', 'restaurant', 'üçΩÔ∏è', markerColors.restaurant),
                loadPlaces('gymsList', coords, 'leisure', 'fitness_centre', 'üèãÔ∏è', markerColors.gym),
                loadPlaces('skatingList', coords, 'leisure', 'ice_rink', '‚õ∏Ô∏è', markerColors.skating),
                loadPilatesStudios('pilatesList', coords),
                loadBasketballCourts('basketballList', coords),
                loadGroceryStores('groceryList', coords)
            ]);

            // Fit map to show all markers if we have places
            if (placeMarkers.length > 0) {
                const listingCoords = getCoords();
                const allPoints = [[listingCoords.lat, listingCoords.lng]];
                placeMarkers.forEach(m => {
                    const latlng = m.getLatLng();
                    allPoints.push([latlng.lat, latlng.lng]);
                });
                map.fitBounds(allPoints, { padding: [30, 30], maxZoom: 15 });
            }
        }

        async function loadPilatesStudios(containerId, coords) {
            const container = document.getElementById(containerId);

            try {
                const radius = 2000; // 2km radius for more specialized places
                // Search for fitness centres with pilates in name, or yoga/pilates studios
                const query = `
                    [out:json][timeout:15];
                    (
                        node["leisure"="fitness_centre"]["name"~"[Pp]ilates"](around:${radius},${coords.lat},${coords.lng});
                        way["leisure"="fitness_centre"]["name"~"[Pp]ilates"](around:${radius},${coords.lat},${coords.lng});
                        node["sport"="yoga"]["name"~"[Pp]ilates"](around:${radius},${coords.lat},${coords.lng});
                        node["leisure"="sports_centre"]["name"~"[Pp]ilates"](around:${radius},${coords.lat},${coords.lng});
                    );
                    out center 10;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const places = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => {
                        const placeLat = el.lat || el.center?.lat;
                        const placeLng = el.lon || el.center?.lon;
                        const distance = calculateDistance(coords.lat, coords.lng, placeLat, placeLng);
                        return { name: el.tags.name, lat: placeLat, lng: placeLng, distance };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                if (places.length === 0) {
                    container.innerHTML = '<li class="no-places">No Pilates studios found nearby</li>';
                } else {
                    // Add markers to map
                    places.forEach(place => {
                        if (place.lat && place.lng) {
                            addPlaceMarker(place, 'üßò', markerColors.pilates);
                        }
                    });

                    container.innerHTML = places.map(place => `
                        <li>
                            <span class="place-name">
                                <span class="place-icon">üßò</span>
                                <a href="${getGoogleMapsUrl(place)}" target="_blank" rel="noopener" class="place-link">${escapeHtml(place.name)}</a>
                            </span>
                            <span class="place-distance">${formatDistance(place.distance)}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading pilates studios:', error);
                container.innerHTML = '<li class="no-places">Could not load Pilates studios</li>';
            }
        }

        async function loadBasketballCourts(containerId, coords) {
            const container = document.getElementById(containerId);

            try {
                const radius = 2000;
                const query = `
                    [out:json][timeout:15];
                    (
                        node["leisure"="pitch"]["sport"="basketball"](around:${radius},${coords.lat},${coords.lng});
                        way["leisure"="pitch"]["sport"="basketball"](around:${radius},${coords.lat},${coords.lng});
                        node["leisure"="sports_centre"]["sport"="basketball"](around:${radius},${coords.lat},${coords.lng});
                    );
                    out center 10;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const places = data.elements
                    .map(el => {
                        const placeLat = el.lat || el.center?.lat;
                        const placeLng = el.lon || el.center?.lon;
                        const distance = calculateDistance(coords.lat, coords.lng, placeLat, placeLng);
                        const name = el.tags?.name || 'Basketball Court';
                        return { name, lat: placeLat, lng: placeLng, distance };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                if (places.length === 0) {
                    container.innerHTML = '<li class="no-places">No basketball courts found nearby</li>';
                } else {
                    // Add markers to map
                    places.forEach(place => {
                        if (place.lat && place.lng) {
                            addPlaceMarker(place, 'üèÄ', markerColors.basketball);
                        }
                    });

                    container.innerHTML = places.map(place => `
                        <li>
                            <span class="place-name">
                                <span class="place-icon">üèÄ</span>
                                <a href="${getGoogleMapsUrl(place)}" target="_blank" rel="noopener" class="place-link">${escapeHtml(place.name)}</a>
                            </span>
                            <span class="place-distance">${formatDistance(place.distance)}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading basketball courts:', error);
                container.innerHTML = '<li class="no-places">Could not load basketball courts</li>';
            }
        }

        async function loadGroceryStores(containerId, coords) {
            const container = document.getElementById(containerId);

            try {
                const radius = 1500;
                const query = `
                    [out:json][timeout:15];
                    (
                        node["shop"="supermarket"](around:${radius},${coords.lat},${coords.lng});
                        way["shop"="supermarket"](around:${radius},${coords.lat},${coords.lng});
                        node["shop"="grocery"](around:${radius},${coords.lat},${coords.lng});
                        node["shop"="organic"](around:${radius},${coords.lat},${coords.lng});
                        node["shop"="greengrocer"](around:${radius},${coords.lat},${coords.lng});
                    );
                    out center 10;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const places = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => {
                        const placeLat = el.lat || el.center?.lat;
                        const placeLng = el.lon || el.center?.lon;
                        const distance = calculateDistance(coords.lat, coords.lng, placeLat, placeLng);
                        return { name: el.tags.name, lat: placeLat, lng: placeLng, distance };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                if (places.length === 0) {
                    container.innerHTML = '<li class="no-places">No grocery stores found nearby</li>';
                } else {
                    // Add markers to map
                    places.forEach(place => {
                        if (place.lat && place.lng) {
                            addPlaceMarker(place, 'üõí', markerColors.grocery);
                        }
                    });

                    container.innerHTML = places.map(place => `
                        <li>
                            <span class="place-name">
                                <span class="place-icon">üõí</span>
                                <a href="${getGoogleMapsUrl(place)}" target="_blank" rel="noopener" class="place-link">${escapeHtml(place.name)}</a>
                            </span>
                            <span class="place-distance">${formatDistance(place.distance)}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading grocery stores:', error);
                container.innerHTML = '<li class="no-places">Could not load grocery stores</li>';
            }
        }

        async function loadPlaces(containerId, coords, key, value, icon, markerColor) {
            const container = document.getElementById(containerId);

            try {
                // Overpass API query for nearby places
                const radius = 1500; // 1.5km radius
                const query = `
                    [out:json][timeout:10];
                    (
                        node["${key}"="${value}"](around:${radius},${coords.lat},${coords.lng});
                        way["${key}"="${value}"](around:${radius},${coords.lat},${coords.lng});
                    );
                    out center 10;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const places = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => {
                        const placeLat = el.lat || el.center?.lat;
                        const placeLng = el.lon || el.center?.lon;
                        const distance = calculateDistance(coords.lat, coords.lng, placeLat, placeLng);
                        return {
                            name: el.tags.name,
                            lat: placeLat,
                            lng: placeLng,
                            distance: distance
                        };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                if (places.length === 0) {
                    container.innerHTML = '<li class="no-places">No places found nearby</li>';
                } else {
                    // Add markers to map
                    places.forEach(place => {
                        if (place.lat && place.lng) {
                            addPlaceMarker(place, icon, markerColor);
                        }
                    });

                    container.innerHTML = places.map(place => `
                        <li>
                            <span class="place-name">
                                <span class="place-icon">${icon}</span>
                                <a href="${getGoogleMapsUrl(place)}" target="_blank" rel="noopener" class="place-link">${escapeHtml(place.name)}</a>
                            </span>
                            <span class="place-distance">${formatDistance(place.distance)}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading places:', error);
                container.innerHTML = '<li class="no-places">Could not load nearby places</li>';
            }
        }

        function addPlaceMarker(place, icon, color) {
            if (!map || !place.lat || !place.lng) return;

            const markerIcon = L.divIcon({
                className: 'place-marker',
                html: `<div style="background:${color};width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);font-size:14px;">${icon}</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const marker = L.marker([place.lat, place.lng], { icon: markerIcon })
                .bindPopup(`
                    <div style="min-width:150px;">
                        <strong>${escapeHtml(place.name)}</strong><br>
                        <span style="color:#666;font-size:0.9em;">${formatDistance(place.distance)} away</span><br>
                        <a href="${getGoogleMapsUrl(place)}" target="_blank" rel="noopener" style="color:#3498db;">Open in Google Maps</a>
                    </div>
                `)
                .addTo(map);

            placeMarkers.push(marker);
        }

        function getGoogleMapsUrl(place) {
            // Always include place name in search so Google Maps finds the actual business
            const placeName = encodeURIComponent(place.name);
            if (place.lat && place.lng) {
                // Use search URL with place name and coordinates for accuracy
                return `https://www.google.com/maps/search/${placeName}/@${place.lat},${place.lng},17z`;
            }
            return `https://www.google.com/maps/search/?api=1&query=${placeName}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return Math.round(meters) + 'm';
            }
            return (meters / 1000).toFixed(1) + 'km';
        }

        async function loadRatings() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/ratings`);
                const ratings = await response.json();
                ratings.forEach(r => {
                    document.querySelectorAll(`.rating-btn[data-author="${r.author}"]`).forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.rating === r.rating);
                    });
                });
            } catch (error) {
                console.error('Error loading ratings:', error);
            }
        }

        async function submitRating(author, rating) {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/ratings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, rating })
                });
                if (response.ok) {
                    loadRatings();
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
            }
        }

        async function loadComments() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/comments`);
                const comments = await response.json();
                renderCommentsForAuthor('commentsAdoyo', comments.filter(c => c.author === 'Adoyo'));
                renderCommentsForAuthor('commentsEmmanuel', comments.filter(c => c.author === 'Emmanuel'));
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        function renderCommentsForAuthor(containerId, comments) {
            const container = document.getElementById(containerId);
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-places">No notes yet.</p>';
                return;
            }
            container.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span>${formatDate(comment.created_at)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                </div>
            `).join('');
        }

        async function submitComment(author) {
            const textarea = document.getElementById('commentText' + author);
            const text = textarea.value.trim();

            if (!text) {
                alert('Please enter a note');
                return;
            }

            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, text })
                });

                if (response.ok) {
                    textarea.value = '';
                    loadComments();
                } else {
                    alert('Failed to post note');
                }
            } catch (error) {
                alert('Error posting note: ' + error.message);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load on page ready
        if (listingId) {
            loadListing();
        } else {
            document.getElementById('listingCard').innerHTML = '<div class="loading">No listing ID provided</div>';
        }
    </script>
</body>
</html>
