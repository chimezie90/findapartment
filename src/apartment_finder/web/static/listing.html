<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Details - Apartment Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.5rem;
        }

        header a {
            color: #3498db;
            text-decoration: none;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: white;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
        }

        .listing-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .listing-price {
            font-size: 2rem;
            font-weight: 700;
            color: #27ae60;
        }

        .listing-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tag-city { background: #e8f4f8; color: #2980b9; }
        .tag-source { background: #f3e5f5; color: #8e24aa; }

        .view-listing-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            margin-top: 15px;
        }

        .view-listing-btn:hover {
            background: #2980b9;
        }

        /* Map */
        #detailMap {
            height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* Scores */
        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .score-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .score-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .score-good { color: #27ae60; }
        .score-ok { color: #f39c12; }
        .score-bad { color: #e74c3c; }

        /* Nearby places */
        .places-list {
            list-style: none;
        }

        .places-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .places-list li:last-child {
            border-bottom: none;
        }

        .place-name {
            font-weight: 500;
        }

        .place-distance {
            color: #666;
            font-size: 0.9rem;
        }

        .place-icon {
            margin-right: 8px;
        }

        .no-places {
            color: #999;
            font-style: italic;
            padding: 10px 0;
        }

        /* Comments */
        .comment {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #666;
        }

        .comment-author {
            font-weight: 600;
            color: #2c3e50;
        }

        .comment-text {
            color: #333;
        }

        .comment-form {
            margin-top: 15px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .comment-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-top: 10px;
        }

        .comment-form button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }

        .comment-form button:hover {
            background: #219a52;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .listing-header {
                flex-direction: column;
            }

            .scores-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="back-link">‚Üê Back to listings</a>
            <h1 id="headerTitle">Loading...</h1>
        </div>
    </header>

    <div class="container">
        <div class="card" id="listingCard">
            <div class="loading">Loading listing details...</div>
        </div>

        <div class="card">
            <h2>Location & Walkability</h2>
            <div id="detailMap"></div>
            <div class="scores-grid" id="scoresGrid">
                <div class="score-item">
                    <div class="score-value" id="walkScore">--</div>
                    <div class="score-label">Walk Score</div>
                </div>
                <div class="score-item">
                    <div class="score-value" id="transitScore">--</div>
                    <div class="score-label">Transit Score</div>
                </div>
                <div class="score-item">
                    <div class="score-value" id="bikeScore">--</div>
                    <div class="score-label">Bike Score</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Nearby Restaurants</h2>
            <ul class="places-list" id="restaurantsList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Gyms</h2>
            <ul class="places-list" id="gymsList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Nearby Ice Skating Rinks</h2>
            <ul class="places-list" id="skatingList">
                <li class="loading">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h2>Comments</h2>
            <div id="commentsList"></div>
            <div class="comment-form">
                <input type="text" id="commentAuthor" placeholder="Your name (optional)">
                <textarea id="commentText" placeholder="Add a comment about this listing..."></textarea>
                <button onclick="submitComment()">Post Comment</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let listing = null;
        let map = null;
        const listingId = new URLSearchParams(window.location.search).get('id');

        // City centers for fallback
        const cityCenters = {
            'New York City': { lat: 40.7128, lng: -74.0060 },
            'New York': { lat: 40.7128, lng: -74.0060 },
            'Los Angeles': { lat: 34.0522, lng: -118.2437 },
            'Dubai': { lat: 25.2048, lng: 55.2708 },
            'Lisbon': { lat: 38.7223, lng: -9.1393 }
        };

        async function loadListing() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}`);
                if (!response.ok) throw new Error('Listing not found');
                listing = await response.json();
                renderListing();
                initMap();
                loadNearbyPlaces();
                loadComments();
            } catch (error) {
                document.getElementById('listingCard').innerHTML = `
                    <div class="loading">Error: ${error.message}</div>
                `;
            }
        }

        function renderListing() {
            document.getElementById('headerTitle').textContent = listing.title || 'Untitled Listing';
            document.title = `${listing.title || 'Listing'} - Apartment Finder`;

            const price = listing.price_usd
                ? '$' + listing.price_usd.toLocaleString('en-US', { maximumFractionDigits: 0 }) + '/mo'
                : 'Price N/A';

            document.getElementById('listingCard').innerHTML = `
                <div class="listing-header">
                    <div>
                        <h1 class="listing-title">${escapeHtml(listing.title || 'Untitled')}</h1>
                        <div class="listing-meta">
                            <span class="tag tag-city">${escapeHtml(listing.city || 'Unknown')}</span>
                            <span class="tag tag-source">${escapeHtml(listing.source_name || 'Unknown')}</span>
                        </div>
                    </div>
                    <div class="listing-price">${price}</div>
                </div>
                <a href="${listing.url}" target="_blank" rel="noopener" class="view-listing-btn">
                    View Original Listing ‚Üí
                </a>
            `;
        }

        function getCoords() {
            if (listing.latitude && listing.longitude) {
                return { lat: listing.latitude, lng: listing.longitude };
            }
            // Fallback to city center
            for (const [city, coords] of Object.entries(cityCenters)) {
                if (listing.city && listing.city.includes(city)) {
                    return coords;
                }
            }
            return cityCenters['New York City'];
        }

        function initMap() {
            const coords = getCoords();
            map = L.map('detailMap').setView([coords.lat, coords.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            L.marker([coords.lat, coords.lng]).addTo(map);

            // Estimate walkability based on location
            estimateScores(coords);
        }

        function estimateScores(coords) {
            // Simulate walkability scores based on city
            // In a real app, you'd call Walk Score API
            let walkScore, transitScore, bikeScore;

            if (listing.city?.includes('New York')) {
                walkScore = 85 + Math.floor(Math.random() * 15);
                transitScore = 90 + Math.floor(Math.random() * 10);
                bikeScore = 70 + Math.floor(Math.random() * 20);
            } else if (listing.city?.includes('Los Angeles')) {
                walkScore = 50 + Math.floor(Math.random() * 30);
                transitScore = 40 + Math.floor(Math.random() * 30);
                bikeScore = 55 + Math.floor(Math.random() * 25);
            } else if (listing.city?.includes('Dubai')) {
                walkScore = 40 + Math.floor(Math.random() * 30);
                transitScore = 50 + Math.floor(Math.random() * 30);
                bikeScore = 30 + Math.floor(Math.random() * 20);
            } else {
                walkScore = 60 + Math.floor(Math.random() * 30);
                transitScore = 55 + Math.floor(Math.random() * 30);
                bikeScore = 50 + Math.floor(Math.random() * 30);
            }

            setScore('walkScore', walkScore);
            setScore('transitScore', transitScore);
            setScore('bikeScore', bikeScore);
        }

        function setScore(id, score) {
            const el = document.getElementById(id);
            el.textContent = score;
            el.className = 'score-value ' + (score >= 70 ? 'score-good' : score >= 50 ? 'score-ok' : 'score-bad');
        }

        async function loadNearbyPlaces() {
            const coords = getCoords();

            // Load restaurants, gyms, and skating rinks using Overpass API
            await Promise.all([
                loadPlaces('restaurantsList', coords, 'amenity', 'restaurant', 'üçΩÔ∏è'),
                loadPlaces('gymsList', coords, 'leisure', 'fitness_centre', 'üèãÔ∏è'),
                loadPlaces('skatingList', coords, 'leisure', 'ice_rink', '‚õ∏Ô∏è')
            ]);
        }

        async function loadPlaces(containerId, coords, key, value, icon) {
            const container = document.getElementById(containerId);

            try {
                // Overpass API query for nearby places
                const radius = 1500; // 1.5km radius
                const query = `
                    [out:json][timeout:10];
                    (
                        node["${key}"="${value}"](around:${radius},${coords.lat},${coords.lng});
                        way["${key}"="${value}"](around:${radius},${coords.lat},${coords.lng});
                    );
                    out center 10;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                const places = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => {
                        const placeLat = el.lat || el.center?.lat;
                        const placeLng = el.lon || el.center?.lon;
                        const distance = calculateDistance(coords.lat, coords.lng, placeLat, placeLng);
                        return {
                            name: el.tags.name,
                            distance: distance
                        };
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                if (places.length === 0) {
                    container.innerHTML = '<li class="no-places">No places found nearby</li>';
                } else {
                    container.innerHTML = places.map(place => `
                        <li>
                            <span class="place-name"><span class="place-icon">${icon}</span>${escapeHtml(place.name)}</span>
                            <span class="place-distance">${formatDistance(place.distance)}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading places:', error);
                container.innerHTML = '<li class="no-places">Could not load nearby places</li>';
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return Math.round(meters) + 'm';
            }
            return (meters / 1000).toFixed(1) + 'km';
        }

        async function loadComments() {
            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/comments`);
                const comments = await response.json();
                renderComments(comments);
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        function renderComments(comments) {
            const container = document.getElementById('commentsList');
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-places">No comments yet. Be the first to comment!</p>';
                return;
            }

            container.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author || 'Anonymous')}</span>
                        <span>${formatDate(comment.created_at)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                </div>
            `).join('');
        }

        async function submitComment() {
            const author = document.getElementById('commentAuthor').value.trim();
            const text = document.getElementById('commentText').value.trim();

            if (!text) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await fetch(`/api/listing/${encodeURIComponent(listingId)}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, text })
                });

                if (response.ok) {
                    document.getElementById('commentAuthor').value = '';
                    document.getElementById('commentText').value = '';
                    loadComments();
                } else {
                    alert('Failed to post comment');
                }
            } catch (error) {
                alert('Error posting comment: ' + error.message);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load on page ready
        if (listingId) {
            loadListing();
        } else {
            document.getElementById('listingCard').innerHTML = '<div class="loading">No listing ID provided</div>';
        }
    </script>
</body>
</html>
